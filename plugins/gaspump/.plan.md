# Plan: gas_deploy_token — Deploy GasPump tokens on-chain

## Context

We reverse-engineered the full GasPump v9 token deployment flow by:
1. Extracting contract code (BOC) from 2 live tokens — identical across all v9
2. Parsing the state init data cell structure — 100% reproduced (address match on 2 tokens)
3. Analyzing the deploy_and_buy transaction body — simple BondingCurveBuy op

### Verified State Init Format

```
StateInit = { code: CODE_V9, data: DATA_CELL }

DATA_CELL (792 bits, 3 refs):
  Bool(false)                     — initial flag
  Address(owner)                  — deployer's TON wallet
  Int257(nonce)                   — salt for unique address (0, 1, 2...)
  Address(ADMIN)                  — EQARmGWyt9u3zZPY8K4vUrqjNzEAHQGAZaI8XFibgUzYcy7B (constant)
  Ref0: walletCodeCell            — constant for v9
  Ref1: wrappedContent            — TEP-64 {name, "gas"+ticker, image, desc+" (launched on ⛽️ GasPump)", dexType}
  Ref2: unwrappedContent          — TEP-64 {name, ticker, image, desc+" (launched on ⛽️ GasPump)", dexType}
```

### Deploy Message Body

```
op: 0x6CD3E4B0 (BondingCurveBuy)
doBuy: true (1 bit)
hasLimit: false (1 bit)
TON amount for initial buy = message value (min 0.3 TON)
```

### Agent Wallet

The agent has its own TON wallet at `~/.teleton/wallet.json` (WalletContractV5R1, 24-word mnemonic).
The plugin signs and sends deploy transactions directly — no external wallet needed.

---

## Files to Create/Modify

### 1. NEW: `plugins/gaspump/deploy.js` — Contract builder module

Contains all the on-chain construction logic, isolated from the MCP tool layer.

**Constants (embedded):**
- `CODE_V9_BOC` — base64 string (15448 chars), the v9 contract code cell
- `WALLET_CODE_V9_BOC` — base64 string, the jetton wallet code cell
- `ADMIN_ADDRESS` — `EQARmGWyt9u3zZPY8K4vUrqjNzEAHQGAZaI8XFibgUzYcy7B`
- `BONDING_CURVE_BUY_OP` — `0x6CD3E4B0`
- `DESC_SUFFIX` — ` (launched on ⛽️ GasPump)`

**Exports:**

```javascript
// Get agent wallet address from ~/.teleton/wallet.json
export function getAgentWalletAddress()

// Build the full state init for a GasPump v9 token
export function buildGaspumpStateInit(ownerAddress, nonce, name, ticker, imageUrl, description, dexType)
// Returns: { stateInit: { code, data }, address: Address }

// Build the deploy+buy message body (BondingCurveBuy)
export function buildDeployBody(doBuy = true)

// Sign and send deploy transaction from the agent's wallet
export async function sendDeploy(tokenAddress, stateInit, body, buyTon)
// Returns: { seqno, walletAddress }
```

### 2. MODIFY: `plugins/gaspump/index.js` — Add 3 new tools

**Tool 9: `gas_preview_deploy`** (no auth needed, pure computation)

Computes the token address and returns a preview without deploying. Uses agent's wallet as owner.

```
Parameters:
  name: string (required)
  ticker: string (required)
  image_url: string (required) — from gas_upload_image
  description: string (optional)
  dex_type: string (optional, default "dedust") — "dedust" or "stonfi"
  nonce: integer (optional, default 0) — increment if address collision

Returns:
  token_address: string — predicted contract address
  owner_address: string — agent's wallet address
  wrapped_symbol: string — "gas" + ticker
  full_description: string — with suffix appended
  nonce: number
```

**Tool 10: `gas_deploy_token`** (auth required)

Full deploy: computes state init, signs and sends from agent wallet, registers on Gas111 API.

```
Parameters:
  name: string (required)
  ticker: string (required)
  image_url: string (required)
  description: string (optional)
  dex_type: string (optional, default "dedust")
  nonce: integer (optional, default 0)
  buy_ton: string (optional, default "5") — TON amount for initial buy

Returns:
  token_address: string
  wallet_address: string — agent's wallet that signed
  seqno: number — wallet sequence number
  api_registered: boolean — whether /tokens/create succeeded
  message: string
```

Flow:
1. `getAgentWalletAddress()` → owner
2. `buildGaspumpStateInit()` → get stateInit + address
3. `buildDeployBody()` → BondingCurveBuy message
4. `sendDeploy()` → sign and send on-chain
5. `gasAuthFetch(bridge, "/tokens/create", ...)` → register on Gas111 (best-effort)

**Tool 11: `gas_confirm_deploy`** (auth required)

Register an on-chain deploy tx on Gas111. Use as retry if API registration failed.

```
Parameters:
  token_address: string (required)
  tx_hash: string (optional) — the on-chain transaction hash
  ton_value: string (optional) — TON amount sent

Returns:
  success: boolean
  message: string
```

Flow:
1. `gasAuthFetch(bridge, "/transactions/create", ...)` (if tx_hash provided)
2. `gasAuthFetch(bridge, "/transactions/trigger", { token_address })`

### 3. MODIFY: `plugins/gaspump/manifest.json`

Add 3 new tools to the tools array:
```json
{ "name": "gas_preview_deploy", "description": "Preview token deploy (compute address)" },
{ "name": "gas_deploy_token", "description": "Deploy a new token on Gas111" },
{ "name": "gas_confirm_deploy", "description": "Confirm deploy after wallet signing" }
```

### 4. MODIFY: `plugins/gaspump/README.md`

- Add "Deploy" section to token launch flow
- Document the new 3-step deploy process (preview → sign → confirm)
- Add schema tables for new tools
- Note the Tonkeeper requirement for signing

### 5. Save contract constants

Extract and save from existing tokens:
- Code cell BOC (base64) — embed in deploy.js
- Wallet code cell BOC (base64) — embed in deploy.js

---

## Token Launch Flow (updated)

```
1. gas_login                  → authenticate via WebApp
2. gas_upload_image            → upload token image, get URL
3. gas_preview_deploy          → compute address, check parameters
4. gas_deploy_token            → sign + send on-chain + register on API
5. gas_token_info              → verify deployment status (~15s later)
6. gas_confirm_deploy          → (only if API registration failed in step 4)
```

---

## Dependencies

- `@ton/core` — Cell building, Address computation, Dictionary, stateInit
- `@ton/ton` — WalletContractV5R1, TonClient, internal message builder
- `@ton/crypto` — mnemonicToPrivateKey for wallet signing
- `@orbs-network/ton-access` (optional) — Decentralized RPC endpoint (falls back to toncenter.com)
- `crypto` (Node.js built-in) — SHA256 for TEP-64 keys
- Agent wallet at `~/.teleton/wallet.json` — 24-word mnemonic, WalletContractV5R1

---

## Edge Cases

1. **Address collision**: if `nonce=0` produces an address that's already deployed, user increments nonce
2. **API registration before deploy**: Gas111's `/tokens/create` might reject if the token isn't deployed yet. If so, reverse the order: deploy first, then register. We'll test and handle both cases.
3. **Insufficient balance**: the agent wallet needs enough TON to cover `buy_ton` + gas (~0.1 TON). If balance is too low, the sendTransfer will fail.
4. **Contract version**: hardcoded to v9. If Gas111 releases v10+, the code/wallet BOCs and possibly the data format will change. The plugin should log the version and we can update the constants.

---

## Verification

1. `node -e "import('./plugins/gaspump/index.js').then(m => console.log(m.tools.length, 'tools'))"` → 11 tools ✅
2. Unit test: `buildGaspumpStateInit()` with Token1 params (nonce=1) → `EQBPHXRRu9jRKbAVXZsCVNVJjJKJ6WygyTSshvv9CbpibxWQ` ✅
3. Unit test: `buildGaspumpStateInit()` with Token2 params (nonce=0) → `EQAhpmmflUsrpWrrb_KwWbGDQ6i3teQuIOLSdp1jx6xdi2Bz` ✅
4. E2E: call `gas_preview_deploy` with test params → returns valid address
5. E2E: call `gas_deploy_token` → signs, sends on-chain, registers on API
